<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride-Together Admin Panel</title>
    <!-- Tailwind CSS के लिए CDN लिंक -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- इंटर फ़ॉन्ट के लिए CDN लिंक -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- मुख्य कंटेनर -->
    <div id="main-app" class="bg-white rounded-xl shadow-xl p-8 w-full max-w-2xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">एडमिन पैनल</h1>
            <div class="space-x-2">
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-full font-medium shadow-md hover:bg-red-600 transition-colors">लॉगआउट</button>
            </div>
        </header>

        <!-- लोडिंग स्क्रीन -->
        <div id="loading-screen" class="flex flex-col items-center justify-center text-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600">लोड हो रहा है...</p>
        </div>

        <!-- सामग्री -->
        <div id="admin-content" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">सभी उपयोगकर्ता</h2>
            <div id="users-list" class="space-y-4">
                <p class="text-gray-500">उपयोगकर्ता सूची लोड हो रही है...</p>
            </div>

            <hr class="my-8 border-t-2 border-gray-200">

            <h2 class="text-2xl font-semibold mb-4">सभी राइड रिक्वेस्ट</h2>
            <div id="rides-list" class="space-y-4">
                <p class="text-gray-500">राइड रिक्वेस्ट लोड हो रही है...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK के लिए स्क्रिप्ट -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase के लिए ग्लोबल वेरिएबल्स
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI एलिमेंट्स
        const loadingScreen = document.getElementById('loading-screen');
        const adminContent = document.getElementById('admin-content');
        const usersList = document.getElementById('users-list');
        const ridesList = document.getElementById('rides-list');
        const logoutBtn = document.getElementById('logout-btn');

        let app, auth, db;

        // Firebase को इनिशियलाइज़ करता है और यूज़र को प्रमाणित करता है।
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                             // यहाँ पर आप असली ऐप में एडमिन की भूमिका जाँचेंगे।
                             // सुरक्षा नियमों के कारण, हम यहाँ सभी को एडमिन मानते हैं।
                            fetchData();
                            adminContent.classList.remove('hidden');
                        } else {
                            // अगर यूज़र लॉग आउट है, तो लॉगिन स्क्रीन पर रीडायरेक्ट करें (या कुछ और दिखाएं)।
                            console.log("No user is signed in.");
                            loadingScreen.innerHTML = '<p class="text-red-500">लॉग इन करें.</p>';
                        }
                    });

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    console.error("Firebase config is not available. Check the environment setup.");
                    loadingScreen.innerHTML = '<p class="text-red-500">Firebase कॉन्फ़िगरेशन उपलब्ध नहीं है।</p>';
                }
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                loadingScreen.innerHTML = `<p class="text-red-500">एक त्रुटि हुई: ${error.message}</p>`;
            }
        }
        
        // Firestore से डेटा लाता है और UI को अपडेट करता है।
        function fetchData() {
             // उपयोगकर्ताओं की सूची को रीयल-टाइम में सुनें।
            const usersCollection = collection(db, `artifacts/${appId}/users`);
            onSnapshot(usersCollection, (snapshot) => {
                usersList.innerHTML = '';
                snapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userId = userDoc.id;
                    if (userData.data?.user_profile) {
                         const userProfile = userData.data.user_profile;
                         const userDiv = document.createElement('div');
                         userDiv.className = "p-4 bg-gray-100 rounded-lg shadow-sm";
                         userDiv.innerHTML = `
                             <p class="font-bold">User ID: ${userId}</p>
                             <p class="text-sm text-gray-700">Email: ${userProfile.email || 'N/A'}</p>
                             <p class="text-sm text-gray-700">Role: <span id="role-${userId}" class="font-medium">${userProfile.role}</span></p>
                             <button class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-full text-xs" onclick="changeUserRole('${userId}')">भूमिका बदलें</button>
                         `;
                         usersList.appendChild(userDiv);
                    }
                });
            });

             // राइड्स की सूची को रीयल-टाइम में सुनें।
            const ridesCollection = collection(db, `artifacts/${appId}/public/data/rides`);
            onSnapshot(ridesCollection, (snapshot) => {
                ridesList.innerHTML = '';
                snapshot.forEach(rideDoc => {
                    const rideData = rideDoc.data();
                    const rideDiv = document.createElement('div');
                    rideDiv.className = "p-4 bg-yellow-100 rounded-lg shadow-sm";
                    rideDiv.innerHTML = `
                        <p class="font-bold">Ride ID: ${rideDoc.id}</p>
                        <p class="text-sm text-gray-700">Passenger ID: ${rideData.passengerId}</p>
                        <p class="text-sm text-gray-700">Pickup: ${rideData.pickup}</p>
                        <p class="text-sm text-gray-700">Drop: ${rideData.drop}</p>
                        <p class="text-sm text-gray-700">Status: ${rideData.status}</p>
                    `;
                    ridesList.appendChild(rideDiv);
                });
            });
        }
        
        // यूज़र की भूमिका को बदलने के लिए एक फ़ंक्शन
        window.changeUserRole = async (targetUserId) => {
            const roleEl = document.getElementById(`role-${targetUserId}`);
            const currentRole = roleEl.textContent;
            const newRole = currentRole === 'passenger' ? 'driver' : 'passenger';
            
            try {
                const userRef = doc(db, `artifacts/${appId}/users/${targetUserId}/data/user_profile`);
                await updateDoc(userRef, { role: newRole });
                console.log(`User ${targetUserId} role updated to ${newRole}`);
            } catch (e) {
                console.error("भूमिका अपडेट करने में त्रुटि:", e);
                alert("भूमिका अपडेट करने में त्रुटि हुई।");
            }
        };

        // लॉगआउट हैंडलर
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            // लॉगआउट के बाद, यूजर को ऐप के मुख्य पेज पर रीडायरेक्ट करें
            window.location.href = './ride_together_app.html';
        });

        // ऐप को शुरू करें
        initializeFirebase();
    </script>
</body>
</html>
